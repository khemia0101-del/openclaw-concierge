{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{z}from\"zod\";import{publicProcedure,protectedProcedure,router}from\"../../../_core/trpc\";import{getDb}from\"../../../db\";import{affiliates,referrals,commissions}from\"../../../../drizzle/schema\";import{eq,and,desc}from\"drizzle-orm\";import{TRPCError}from\"@trpc/server\";function generateAffiliateCode(name){const cleanName=name.replace(/[^a-zA-Z0-9]/g,\"\").toUpperCase().slice(0,6);const randomSuffix=Math.random().toString(36).substring(2,6).toUpperCase();return`${cleanName}${randomSuffix}`}__name(generateAffiliateCode,\"generateAffiliateCode\");const affiliateRouter=router({getMyAffiliate:protectedProcedure.query(async({ctx})=>{const db=await getDb();if(!db)throw new TRPCError({code:\"INTERNAL_SERVER_ERROR\",message:\"Database unavailable\"});const[affiliate]=await db.select().from(affiliates).where(eq(affiliates.userId,ctx.user.id)).limit(1);return affiliate||null}),createAffiliate:protectedProcedure.mutation(async({ctx})=>{const db=await getDb();if(!db)throw new TRPCError({code:\"INTERNAL_SERVER_ERROR\",message:\"Database unavailable\"});const[existing]=await db.select().from(affiliates).where(eq(affiliates.userId,ctx.user.id)).limit(1);if(existing){throw new TRPCError({code:\"BAD_REQUEST\",message:\"You already have an affiliate account\"})}let affiliateCode=generateAffiliateCode(ctx.user.name||ctx.user.email);let attempts=0;while(attempts<10){const[existingCode]=await db.select().from(affiliates).where(eq(affiliates.affiliateCode,affiliateCode)).limit(1);if(!existingCode)break;affiliateCode=generateAffiliateCode(ctx.user.name||ctx.user.email);attempts++}const[newAffiliate]=await db.insert(affiliates).values({userId:ctx.user.id,affiliateCode,status:\"active\",commissionRate:\"30.00\"});return{success:true,affiliateCode}}),updatePaymentInfo:protectedProcedure.input(z.object({paypalEmail:z.string().email().optional(),bankDetails:z.any().optional()})).mutation(async({ctx,input})=>{const db=await getDb();if(!db)throw new TRPCError({code:\"INTERNAL_SERVER_ERROR\",message:\"Database unavailable\"});const[affiliate]=await db.select().from(affiliates).where(eq(affiliates.userId,ctx.user.id)).limit(1);if(!affiliate){throw new TRPCError({code:\"NOT_FOUND\",message:\"Affiliate account not found\"})}await db.update(affiliates).set({paypalEmail:input.paypalEmail,bankDetails:input.bankDetails}).where(eq(affiliates.id,affiliate.id));return{success:true}}),getStats:protectedProcedure.query(async({ctx})=>{const db=await getDb();if(!db)throw new TRPCError({code:\"INTERNAL_SERVER_ERROR\",message:\"Database unavailable\"});const[affiliate]=await db.select().from(affiliates).where(eq(affiliates.userId,ctx.user.id)).limit(1);if(!affiliate){return null}const allReferrals=await db.select().from(referrals).where(eq(referrals.affiliateId,affiliate.id));const totalReferrals=allReferrals.length;const signedUpReferrals=allReferrals.filter(r=>r.status===\"signed_up\"||r.status===\"subscribed\").length;const subscribedReferrals=allReferrals.filter(r=>r.status===\"subscribed\").length;return{totalReferrals,signedUpReferrals,subscribedReferrals,conversionRate:totalReferrals>0?(subscribedReferrals/totalReferrals*100).toFixed(1):\"0\"}}),getReferrals:protectedProcedure.query(async({ctx})=>{const db=await getDb();if(!db)throw new TRPCError({code:\"INTERNAL_SERVER_ERROR\",message:\"Database unavailable\"});const[affiliate]=await db.select().from(affiliates).where(eq(affiliates.userId,ctx.user.id)).limit(1);if(!affiliate){return[]}const referralsList=await db.select().from(referrals).where(eq(referrals.affiliateId,affiliate.id)).orderBy(desc(referrals.createdAt)).limit(50);return referralsList}),getCommissions:protectedProcedure.query(async({ctx})=>{const db=await getDb();if(!db)throw new TRPCError({code:\"INTERNAL_SERVER_ERROR\",message:\"Database unavailable\"});const[affiliate]=await db.select().from(affiliates).where(eq(affiliates.userId,ctx.user.id)).limit(1);if(!affiliate){return[]}const commissionsList=await db.select().from(commissions).where(eq(commissions.affiliateId,affiliate.id)).orderBy(desc(commissions.createdAt)).limit(50);return commissionsList}),trackClick:publicProcedure.input(z.object({affiliateCode:z.string(),ipAddress:z.string().optional(),userAgent:z.string().optional()})).mutation(async({input})=>{const db=await getDb();if(!db)throw new TRPCError({code:\"INTERNAL_SERVER_ERROR\",message:\"Database unavailable\"});const[affiliate]=await db.select().from(affiliates).where(eq(affiliates.affiliateCode,input.affiliateCode)).limit(1);if(!affiliate||affiliate.status!==\"active\"){throw new TRPCError({code:\"NOT_FOUND\",message:\"Invalid affiliate code\"})}await db.insert(referrals).values({affiliateId:affiliate.id,status:\"pending\",ipAddress:input.ipAddress,userAgent:input.userAgent});return{success:true}}),linkReferralToUser:protectedProcedure.input(z.object({affiliateCode:z.string()})).mutation(async({ctx,input})=>{const db=await getDb();if(!db)throw new TRPCError({code:\"INTERNAL_SERVER_ERROR\",message:\"Database unavailable\"});const[affiliate]=await db.select().from(affiliates).where(eq(affiliates.affiliateCode,input.affiliateCode)).limit(1);if(!affiliate){return{success:false}}const[referral]=await db.select().from(referrals).where(and(eq(referrals.affiliateId,affiliate.id),eq(referrals.status,\"pending\"))).orderBy(desc(referrals.createdAt)).limit(1);if(referral){await db.update(referrals).set({referredUserId:ctx.user.id,referredEmail:ctx.user.email,status:\"signed_up\",signedUpAt:new Date}).where(eq(referrals.id,referral.id))}return{success:true}})});export{affiliateRouter};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/home/ubuntu/openclaw-concierge/server/api/trpc/routers/affiliate.ts"],"sourcesContent":[null]}}