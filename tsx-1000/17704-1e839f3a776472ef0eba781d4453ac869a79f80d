{"code":"import{COOKIE_NAME}from\"@shared/const\";import{getSessionCookieOptions}from\"./_core/cookies\";import{systemRouter}from\"./_core/systemRouter\";import{publicProcedure,router,protectedProcedure}from\"./_core/trpc\";import{z}from\"zod\";import*as db from\"./db\";import*as stripeService from\"./services/stripe\";import*as digitaloceanService from\"./services/digitalocean\";import{affiliateRouter}from\"./api/trpc/routers/affiliate\";const appRouter=router({system:systemRouter,auth:router({me:publicProcedure.query(opts=>opts.ctx.user),logout:publicProcedure.mutation(({ctx})=>{const cookieOptions=getSessionCookieOptions(ctx.req);ctx.res.clearCookie(COOKIE_NAME,{...cookieOptions,maxAge:-1});return{success:true}})}),onboarding:router({createCheckout:publicProcedure.input(z.object({email:z.string().email(),tier:z.enum([\"starter\",\"pro\",\"business\"]),userId:z.number().int().max(2147483647),origin:z.string().url()})).mutation(async({input})=>{await db.captureLead({email:input.email,selectedTier:input.tier,status:\"checkout_started\",source:\"onboarding\"});const session=await stripeService.createCheckoutSession({customerEmail:input.email,tier:input.tier,userId:input.userId,successUrl:`${input.origin}/onboarding/configure?session_id={CHECKOUT_SESSION_ID}`,cancelUrl:`${input.origin}/onboarding/payment`});await db.updateLeadStatus(input.email,\"checkout_started\",session.id);return{sessionUrl:session.url||\"\",sessionId:session.id}}),verifyPayment:publicProcedure.input(z.object({sessionId:z.string()})).mutation(async({input})=>{const session=await stripeService.getCheckoutSession(input.sessionId);if(session.payment_status!==\"paid\"){throw new Error(\"Payment not completed\")}const tier=session.metadata?.tier;if(!tier){throw new Error(\"Tier information missing from payment session\")}const userId=parseInt(session.metadata?.userId||session.client_reference_id||\"0\");if(!userId||userId>2147483647){throw new Error(\"User ID missing or invalid in payment session\")}const existing=await db.getSubscriptionByUserId(userId);if(!existing){const monthlyPriceValue=(stripeService.PRICING[tier].monthlyPrice/100).toFixed(2);let stripeCustomerId=void 0;if(typeof session.customer===\"string\"&&session.customer){stripeCustomerId=session.customer}else if(typeof session.customer===\"object\"&&session.customer?.id){stripeCustomerId=session.customer.id}let stripeSubscriptionId=void 0;if(session.subscription){if(typeof session.subscription===\"string\"&&session.subscription){stripeSubscriptionId=session.subscription}else if(typeof session.subscription===\"object\"&&session.subscription.id){stripeSubscriptionId=session.subscription.id}}const renewalDate=await stripeService.getRenewalDate(stripeSubscriptionId);await db.createSubscriptionRaw({userId,tier,status:\"active\",setupFeePaid:true,stripeCustomerId:stripeCustomerId||null,stripeSubscriptionId:stripeSubscriptionId||null,monthlyPrice:monthlyPriceValue,startDate:new Date,renewalDate});const setupFee=stripeService.PRICING[tier].setupFee;const monthlyFee=stripeService.PRICING[tier].monthlyPrice;const setupBillingResult=await db.createBillingRecord({userId,type:\"setup_fee\",amount:(setupFee/100).toFixed(2),status:\"completed\",stripeChargeId:session.payment_intent});const monthlyBillingResult=await db.createBillingRecord({userId,type:\"monthly_subscription\",amount:(monthlyFee/100).toFixed(2),status:\"completed\"});const newSub=await db.getSubscriptionByUserId(userId);if(newSub){await db.createAffiliateCommission(userId,newSub.id,setupBillingResult,monthlyBillingResult)}}const email=session.metadata?.customerEmail||session.customer_email||\"\";return{success:true,email,tier,userId}}),getInstanceStatus:publicProcedure.input(z.object({userId:z.number().int().max(2147483647),sessionId:z.string().min(1)})).query(async({input})=>{const session=await stripeService.getCheckoutSession(input.sessionId);const metadataUserId=parseInt(session.metadata?.userId||\"0\");if(metadataUserId!==input.userId){throw new Error(\"Session does not match user\")}const instance=await db.getAIInstanceByUserId(input.userId);if(!instance)return null;return{status:instance.status,errorMessage:instance.errorMessage,doAppId:instance.doAppId}}),deployInstance:publicProcedure.input(z.object({sessionId:z.string().min(1),userId:z.number().int().max(2147483647),userEmail:z.string().email(),aiRole:z.string(),telegramBotToken:z.string().regex(/^\\d+:[A-Za-z0-9_-]{20,}$/,\"Invalid Telegram bot token format. Expected format: 123456789:ABCdefGHI_jklMNO-pqrsTUVwxyz\").optional().or(z.literal(\"\")),communicationChannels:z.array(z.string()),connectedServices:z.array(z.string())})).mutation(async({input})=>{const session=await stripeService.getCheckoutSession(input.sessionId);const metadataUserId=parseInt(session.metadata?.userId||\"0\");if(metadataUserId!==input.userId){throw new Error(\"Session does not match user\")}const userId=input.userId;const subscription=await db.getSubscriptionByUserId(userId);if(!subscription){throw new Error(\"No active subscription found\")}const instanceResult=await db.createAIInstance({userId,subscriptionId:subscription.id,status:\"provisioning\",aiRole:input.aiRole,telegramBotToken:input.telegramBotToken,config:{communicationChannels:input.communicationChannels,connectedServices:input.connectedServices}});try{const app=await digitaloceanService.createOpenClawApp({userId,userEmail:input.userEmail,aiRole:input.aiRole,tier:subscription.tier,telegramBotToken:input.telegramBotToken,config:{communicationChannels:input.communicationChannels,connectedServices:input.connectedServices}});await db.updateAIInstance(instanceResult[0].insertId,{doAppId:app.id,status:\"running\"});return{success:true,appId:app.id}}catch(error){await db.updateAIInstance(instanceResult[0].insertId,{status:\"error\",errorMessage:error.message});throw error}})}),affiliate:affiliateRouter,dashboard:router({getStatus:protectedProcedure.query(async({ctx})=>{const subscription=await db.getSubscriptionByUserId(ctx.user.id);let instance=await db.getAIInstanceByUserId(ctx.user.id);const billingRecords=await db.getBillingRecordsByUserId(ctx.user.id);if(instance&&instance.status===\"provisioning\"){const PROVISIONING_TIMEOUT_MS=10*60*1e3;const createdAt=new Date(instance.createdAt).getTime();if(Date.now()-createdAt>PROVISIONING_TIMEOUT_MS){await db.updateAIInstance(instance.id,{status:\"error\",errorMessage:\"Provisioning timed out. Please contact support or try restarting.\"});instance={...instance,status:\"error\",errorMessage:\"Provisioning timed out. Please contact support or try restarting.\"}}}return{subscription,instance,billingRecords}}),restartInstance:protectedProcedure.mutation(async({ctx})=>{const instance=await db.getAIInstanceByUserId(ctx.user.id);if(!instance||!instance.doAppId){throw new Error(\"No instance found\")}await digitaloceanService.restartApp(instance.doAppId);return{success:true}}),getLogs:protectedProcedure.query(async({ctx})=>{const instance=await db.getAIInstanceByUserId(ctx.user.id);if(!instance||!instance.doAppId){return{logs:[]}}const logs=await digitaloceanService.getAppLogs(instance.doAppId);return{logs}})})});export{appRouter};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/home/ubuntu/openclaw-concierge/server/routers.ts"],"sourcesContent":[null]}}