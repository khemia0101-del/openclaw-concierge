{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{eq}from\"drizzle-orm\";import{drizzle}from\"drizzle-orm/mysql2\";import{users}from\"../drizzle/schema\";import{ENV}from\"./_core/env\";let _db=null;async function getDb(){if(!_db&&process.env.DATABASE_URL){try{_db=drizzle(process.env.DATABASE_URL)}catch(error){console.warn(\"[Database] Failed to connect:\",error);_db=null}}return _db}__name(getDb,\"getDb\");async function upsertUser(user){if(!user.openId){throw new Error(\"User openId is required for upsert\")}const db=await getDb();if(!db){console.warn(\"[Database] Cannot upsert user: database not available\");return}try{const values={openId:user.openId,email:user.email||`${user.openId}@temp.openclaw.local`};const updateSet={};if(user.name!==void 0){values.name=user.name??null;updateSet.name=user.name??null}if(user.passwordHash!==void 0){values.passwordHash=user.passwordHash??null;updateSet.passwordHash=user.passwordHash??null}if(user.loginMethod!==void 0){values.loginMethod=user.loginMethod??null;updateSet.loginMethod=user.loginMethod??null}if(user.lastSignedIn!==void 0){values.lastSignedIn=user.lastSignedIn;updateSet.lastSignedIn=user.lastSignedIn}else{values.lastSignedIn=new Date;updateSet.lastSignedIn=new Date}if(user.role!==void 0){values.role=user.role;updateSet.role=user.role}else if(user.openId===ENV.ownerOpenId){values.role=\"admin\";updateSet.role=\"admin\"}else{values.role=\"user\";updateSet.role=\"user\"}await db.insert(users).values(values).onDuplicateKeyUpdate({set:updateSet})}catch(error){console.error(\"[Database] Failed to upsert user:\",error);throw error}}__name(upsertUser,\"upsertUser\");async function getUserByOpenId(openId){const db=await getDb();if(!db){console.warn(\"[Database] Cannot get user: database not available\");return void 0}const result=await db.select().from(users).where(eq(users.openId,openId)).limit(1);return result.length>0?result[0]:void 0}__name(getUserByOpenId,\"getUserByOpenId\");export{getDb,getUserByOpenId,upsertUser};\n","warnings":[],"map":{"version":3,"mappings":"kHAAA,OAAS,OAAU,cACnB,OAAS,YAAe,qBACxB,OAA2B,UAAa,oBACxC,OAAS,QAAW,cAEpB,IAAI,IAAyC,KAG7C,eAAsB,OAAQ,CAC5B,GAAI,CAAC,KAAO,QAAQ,IAAI,aAAc,CACpC,GAAI,CACF,IAAM,QAAQ,QAAQ,IAAI,YAAY,CACxC,OAAS,MAAO,CACd,QAAQ,KAAK,gCAAiC,KAAK,EACnD,IAAM,IACR,CACF,CACA,OAAO,GACT,CAVsB,sBAYtB,eAAsB,WAAW,KAA+D,CAC9F,GAAI,CAAC,KAAK,OAAQ,CAChB,MAAM,IAAI,MAAM,oCAAoC,CACtD,CAEA,MAAM,GAAK,MAAM,MAAM,EACvB,GAAI,CAAC,GAAI,CACP,QAAQ,KAAK,uDAAuD,EACpE,MACF,CAEA,GAAI,CACF,MAAM,OAAkC,CACtC,OAAQ,KAAK,OACb,MAAO,KAAK,OAAS,GAAG,KAAK,MAAM,sBACrC,EACA,MAAM,UAAqC,CAAC,EAE5C,GAAI,KAAK,OAAS,OAAW,CAC3B,OAAO,KAAO,KAAK,MAAQ,KAC3B,UAAU,KAAO,KAAK,MAAQ,IAChC,CACA,GAAI,KAAK,eAAiB,OAAW,CACnC,OAAO,aAAe,KAAK,cAAgB,KAC3C,UAAU,aAAe,KAAK,cAAgB,IAChD,CACA,GAAI,KAAK,cAAgB,OAAW,CAClC,OAAO,YAAc,KAAK,aAAe,KACzC,UAAU,YAAc,KAAK,aAAe,IAC9C,CAEA,GAAI,KAAK,eAAiB,OAAW,CACnC,OAAO,aAAe,KAAK,aAC3B,UAAU,aAAe,KAAK,YAChC,KAAO,CACL,OAAO,aAAe,IAAI,KAC1B,UAAU,aAAe,IAAI,IAC/B,CAEA,GAAI,KAAK,OAAS,OAAW,CAC3B,OAAO,KAAO,KAAK,KACnB,UAAU,KAAO,KAAK,IACxB,SAAW,KAAK,SAAW,IAAI,YAAa,CAC1C,OAAO,KAAO,QACd,UAAU,KAAO,OACnB,KAAO,CACL,OAAO,KAAO,OACd,UAAU,KAAO,MACnB,CAEA,MAAM,GAAG,OAAO,KAAK,EAAE,OAAO,MAAoB,EAAE,qBAAqB,CACvE,IAAK,SACP,CAAC,CACH,OAAS,MAAO,CACd,QAAQ,MAAM,oCAAqC,KAAK,EACxD,MAAM,KACR,CACF,CAzDsB,gCA2DtB,eAAsB,gBAAgB,OAA2C,CAC/E,MAAM,GAAK,MAAM,MAAM,EACvB,GAAI,CAAC,GAAI,CACP,QAAQ,KAAK,oDAAoD,EACjE,OAAO,MACT,CAEA,MAAM,OAAS,MAAM,GAAG,OAAO,EAAE,KAAK,KAAK,EAAE,MAAM,GAAG,MAAM,OAAQ,MAAM,CAAC,EAAE,MAAM,CAAC,EACpF,OAAO,OAAO,OAAS,EAAI,OAAO,CAAC,EAAI,MACzC,CATsB","names":[],"ignoreList":[],"sources":["/home/ubuntu/openclaw-concierge/server/db.ts"],"sourcesContent":[null]}}