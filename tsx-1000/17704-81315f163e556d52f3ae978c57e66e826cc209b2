{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import\"dotenv/config\";import express from\"express\";import{createServer}from\"http\";import net from\"net\";import{createExpressMiddleware}from\"@trpc/server/adapters/express\";import{registerOAuthRoutes}from\"./oauth\";import{registerWebhookRoutes}from\"./webhookRoutes\";import{appRouter}from\"../routers\";import{createContext}from\"./context\";import{serveStatic,setupVite}from\"./vite\";function createRateLimiter(windowMs,max){const hits=new Map;setInterval(()=>{const cutoff=Date.now()-windowMs;hits.forEach((timestamps,key)=>{const valid=timestamps.filter(t=>t>cutoff);if(valid.length===0)hits.delete(key);else hits.set(key,valid)})},6e4).unref();return(req,res,next)=>{const ip=req.ip||req.socket.remoteAddress||\"unknown\";const now=Date.now();const cutoff=now-windowMs;const timestamps=(hits.get(ip)||[]).filter(t=>t>cutoff);if(timestamps.length>=max){res.status(429).json({error:\"Too many requests, please try again later\"});return}timestamps.push(now);hits.set(ip,timestamps);next()}}__name(createRateLimiter,\"createRateLimiter\");function isPortAvailable(port){return new Promise(resolve=>{const server=net.createServer();server.listen(port,()=>{server.close(()=>resolve(true))});server.on(\"error\",()=>resolve(false))})}__name(isPortAvailable,\"isPortAvailable\");async function findAvailablePort(startPort=3e3){for(let port=startPort;port<startPort+20;port++){if(await isPortAvailable(port)){return port}}throw new Error(`No available port found starting from ${startPort}`)}__name(findAvailablePort,\"findAvailablePort\");async function startServer(){const app=express();const server=createServer(app);registerWebhookRoutes(app);app.use(express.json({limit:\"50mb\"}));app.use(express.urlencoded({limit:\"50mb\",extended:true}));registerOAuthRoutes(app);const apiLimiter=createRateLimiter(6e4,100);app.use(\"/api/trpc\",apiLimiter);app.use(\"/api/trpc\",createExpressMiddleware({router:appRouter,createContext}));if(process.env.NODE_ENV===\"development\"){await setupVite(app,server)}else{serveStatic(app)}const preferredPort=parseInt(process.env.PORT||\"3000\");const port=await findAvailablePort(preferredPort);if(port!==preferredPort){console.log(`Port ${preferredPort} is busy, using port ${port} instead`)}server.listen(port,()=>{console.log(`Server running on http://localhost:${port}/`)})}__name(startServer,\"startServer\");startServer().catch(console.error);\n","warnings":[],"map":{"version":3,"mappings":"kHAAA,MAAO,gBACP,OAAO,YAAkD,UACzD,OAAS,iBAAoB,OAC7B,OAAO,QAAS,MAChB,OAAS,4BAA+B,gCACxC,OAAS,wBAA2B,UACpC,OAAS,0BAA6B,kBACtC,OAAS,cAAiB,aAC1B,OAAS,kBAAqB,YAC9B,OAAS,YAAa,cAAiB,SAMvC,SAAS,kBAAkB,SAAkB,IAAa,CACxD,MAAM,KAAO,IAAI,IAGjB,YAAY,IAAM,CAChB,MAAM,OAAS,KAAK,IAAI,EAAI,SAC5B,KAAK,QAAQ,CAAC,WAAsB,MAAgB,CAClD,MAAM,MAAQ,WAAW,OAAQ,GAAc,EAAI,MAAM,EACzD,GAAI,MAAM,SAAW,EAAG,KAAK,OAAO,GAAG,OAClC,KAAK,IAAI,IAAK,KAAK,CAC1B,CAAC,CACH,EAAG,GAAM,EAAE,MAAM,EAEjB,MAAO,CAAC,IAAc,IAAe,OAAuB,CAC1D,MAAM,GAAK,IAAI,IAAM,IAAI,OAAO,eAAiB,UACjD,MAAM,IAAM,KAAK,IAAI,EACrB,MAAM,OAAS,IAAM,SACrB,MAAM,YAAc,KAAK,IAAI,EAAE,GAAK,CAAC,GAAG,OAAQ,GAAc,EAAI,MAAM,EAExE,GAAI,WAAW,QAAU,IAAK,CAC5B,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,2CAA4C,CAAC,EAC3E,MACF,CAEA,WAAW,KAAK,GAAG,EACnB,KAAK,IAAI,GAAI,UAAU,EACvB,KAAK,CACP,CACF,CA5BS,8CA8BT,SAAS,gBAAgB,KAAgC,CACvD,OAAO,IAAI,QAAQ,SAAW,CAC5B,MAAM,OAAS,IAAI,aAAa,EAChC,OAAO,OAAO,KAAM,IAAM,CACxB,OAAO,MAAM,IAAM,QAAQ,IAAI,CAAC,CAClC,CAAC,EACD,OAAO,GAAG,QAAS,IAAM,QAAQ,KAAK,CAAC,CACzC,CAAC,CACH,CARS,0CAUT,eAAe,kBAAkB,UAAoB,IAAuB,CAC1E,QAAS,KAAO,UAAW,KAAO,UAAY,GAAI,OAAQ,CACxD,GAAI,MAAM,gBAAgB,IAAI,EAAG,CAC/B,OAAO,IACT,CACF,CACA,MAAM,IAAI,MAAM,yCAAyC,SAAS,EAAE,CACtE,CAPe,8CASf,eAAe,aAAc,CAC3B,MAAM,IAAM,QAAQ,EACpB,MAAM,OAAS,aAAa,GAAG,EAE/B,sBAAsB,GAAG,EAEzB,IAAI,IAAI,QAAQ,KAAK,CAAE,MAAO,MAAO,CAAC,CAAC,EACvC,IAAI,IAAI,QAAQ,WAAW,CAAE,MAAO,OAAQ,SAAU,IAAK,CAAC,CAAC,EAE7D,oBAAoB,GAAG,EAGvB,MAAM,WAAa,kBAAkB,IAAQ,GAAG,EAChD,IAAI,IAAI,YAAa,UAAU,EAG/B,IAAI,IACF,YACA,wBAAwB,CACtB,OAAQ,UACR,aACF,CAAC,CACH,EAEA,GAAI,QAAQ,IAAI,WAAa,cAAe,CAC1C,MAAM,UAAU,IAAK,MAAM,CAC7B,KAAO,CACL,YAAY,GAAG,CACjB,CAEA,MAAM,cAAgB,SAAS,QAAQ,IAAI,MAAQ,MAAM,EACzD,MAAM,KAAO,MAAM,kBAAkB,aAAa,EAElD,GAAI,OAAS,cAAe,CAC1B,QAAQ,IAAI,QAAQ,aAAa,wBAAwB,IAAI,UAAU,CACzE,CAEA,OAAO,OAAO,KAAM,IAAM,CACxB,QAAQ,IAAI,sCAAsC,IAAI,GAAG,CAC3D,CAAC,CACH,CAxCe,kCA0Cf,YAAY,EAAE,MAAM,QAAQ,KAAK","names":[],"ignoreList":[],"sources":["/home/ubuntu/openclaw-concierge/server/_core/index.ts"],"sourcesContent":[null]}}