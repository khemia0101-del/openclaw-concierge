{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{eq,and,desc,sql as drizzleSql}from\"drizzle-orm\";import{drizzle}from\"drizzle-orm/mysql2\";import{users,subscriptions,aiInstances,billingRecords,leads,referrals,affiliates,commissions}from\"../drizzle/schema\";import{ENV}from\"./_core/env\";let _db=null;async function getDb(){if(!_db&&process.env.DATABASE_URL){try{_db=drizzle(process.env.DATABASE_URL)}catch(error){console.warn(\"[Database] Failed to connect:\",error);_db=null}}return _db}__name(getDb,\"getDb\");async function upsertUser(user){if(!user.openId){throw new Error(\"User openId is required for upsert\")}const db=await getDb();if(!db){console.warn(\"[Database] Cannot upsert user: database not available\");return}try{const values={openId:user.openId,email:user.email||`${user.openId}@temp.openclaw.local`};const updateSet={};if(user.name!==void 0){values.name=user.name??null;updateSet.name=user.name??null}if(user.passwordHash!==void 0){values.passwordHash=user.passwordHash??null;updateSet.passwordHash=user.passwordHash??null}if(user.loginMethod!==void 0){values.loginMethod=user.loginMethod??null;updateSet.loginMethod=user.loginMethod??null}if(user.lastSignedIn!==void 0){values.lastSignedIn=user.lastSignedIn;updateSet.lastSignedIn=user.lastSignedIn}else{values.lastSignedIn=new Date;updateSet.lastSignedIn=new Date}if(user.role!==void 0){values.role=user.role;updateSet.role=user.role}else if(user.openId===ENV.ownerOpenId){values.role=\"admin\";updateSet.role=\"admin\"}else{values.role=\"user\";updateSet.role=\"user\"}await db.insert(users).values(values).onDuplicateKeyUpdate({set:updateSet})}catch(error){console.error(\"[Database] Failed to upsert user:\",error);throw error}}__name(upsertUser,\"upsertUser\");async function getUserByOpenId(openId){const db=await getDb();if(!db){console.warn(\"[Database] Cannot get user: database not available\");return void 0}const result=await db.select().from(users).where(eq(users.openId,openId)).limit(1);return result.length>0?result[0]:void 0}__name(getUserByOpenId,\"getUserByOpenId\");async function createSubscription(data){const db=await getDb();if(!db)throw new Error(\"Database not available\");const result=await db.insert(subscriptions).values(data);return result}__name(createSubscription,\"createSubscription\");async function createSubscriptionRaw(data){const db=await getDb();if(!db)throw new Error(\"Database not available\");const result=await db.execute(drizzleSql`\n    INSERT INTO subscriptions (\n      userId, tier, status, setupFeePaid, \n      stripeCustomerId, stripeSubscriptionId, monthlyPrice, \n      startDate, renewalDate\n    ) VALUES (\n      ${data.userId}, \n      ${data.tier}, \n      ${data.status}, \n      ${data.setupFeePaid?1:0},\n      ${data.stripeCustomerId},\n      ${data.stripeSubscriptionId},\n      ${data.monthlyPrice},\n      ${data.startDate},\n      ${data.renewalDate}\n    )\n  `);return result}__name(createSubscriptionRaw,\"createSubscriptionRaw\");async function getSubscriptionByUserId(userId){const db=await getDb();if(!db)return void 0;const result=await db.select().from(subscriptions).where(eq(subscriptions.userId,userId)).limit(1);return result.length>0?result[0]:void 0}__name(getSubscriptionByUserId,\"getSubscriptionByUserId\");async function updateSubscription(id,data){const db=await getDb();if(!db)throw new Error(\"Database not available\");await db.update(subscriptions).set(data).where(eq(subscriptions.id,id))}__name(updateSubscription,\"updateSubscription\");async function createAIInstance(data){const db=await getDb();if(!db)throw new Error(\"Database not available\");const result=await db.insert(aiInstances).values(data);return result}__name(createAIInstance,\"createAIInstance\");async function getAIInstanceByUserId(userId){const db=await getDb();if(!db)return void 0;const result=await db.select().from(aiInstances).where(eq(aiInstances.userId,userId)).limit(1);return result.length>0?result[0]:void 0}__name(getAIInstanceByUserId,\"getAIInstanceByUserId\");async function updateAIInstance(id,data){const db=await getDb();if(!db)throw new Error(\"Database not available\");await db.update(aiInstances).set(data).where(eq(aiInstances.id,id))}__name(updateAIInstance,\"updateAIInstance\");async function createBillingRecord(data){const db=await getDb();if(!db)throw new Error(\"Database not available\");const result=await db.insert(billingRecords).values(data);return result}__name(createBillingRecord,\"createBillingRecord\");async function getBillingRecordsByUserId(userId){const db=await getDb();if(!db)return[];const result=await db.select().from(billingRecords).where(eq(billingRecords.userId,userId));return result}__name(getBillingRecordsByUserId,\"getBillingRecordsByUserId\");async function captureLead(data){const db=await getDb();if(!db)throw new Error(\"Database not available\");try{await db.insert(leads).values(data).onDuplicateKeyUpdate({set:{selectedTier:data.selectedTier,status:data.status||\"lead\",updatedAt:new Date}})}catch(error){console.error(\"[Database] Failed to capture lead:\",error)}}__name(captureLead,\"captureLead\");async function getLeadByEmail(email){const db=await getDb();if(!db)return void 0;const result=await db.select().from(leads).where(eq(leads.email,email)).limit(1);return result.length>0?result[0]:void 0}__name(getLeadByEmail,\"getLeadByEmail\");async function updateLeadStatus(email,status,stripeSessionId,userId){const db=await getDb();if(!db)throw new Error(\"Database not available\");const updateData={status,updatedAt:new Date};if(stripeSessionId)updateData.stripeSessionId=stripeSessionId;if(userId!=null)updateData.userId=userId;await db.update(leads).set(updateData).where(eq(leads.email,email))}__name(updateLeadStatus,\"updateLeadStatus\");async function createAffiliateCommission(userId,subscriptionId,setupBillingResult,monthlyBillingResult){const db=await getDb();if(!db)return;try{const[referral]=await db.select().from(referrals).where(and(eq(referrals.referredUserId,userId),eq(referrals.status,\"signed_up\"))).orderBy(desc(referrals.createdAt)).limit(1);if(!referral)return;const[affiliate]=await db.select().from(affiliates).where(eq(affiliates.id,referral.affiliateId)).limit(1);if(!affiliate||affiliate.status!==\"active\")return;const rate=parseFloat(affiliate.commissionRate)/100;const allBilling=await getBillingRecordsByUserId(userId);const setupRecord=allBilling.find(r=>r.type===\"setup_fee\");const monthlyRecord=allBilling.find(r=>r.type===\"monthly_subscription\");if(setupRecord){const setupCommission=(parseFloat(setupRecord.amount)*rate).toFixed(2);await db.insert(commissions).values({affiliateId:affiliate.id,referralId:referral.id,subscriptionId,billingRecordId:setupRecord.id,amount:setupCommission,commissionRate:affiliate.commissionRate,status:\"pending\",type:\"setup_fee\"})}if(monthlyRecord){const monthlyCommission=(parseFloat(monthlyRecord.amount)*rate).toFixed(2);await db.insert(commissions).values({affiliateId:affiliate.id,referralId:referral.id,subscriptionId,billingRecordId:monthlyRecord.id,amount:monthlyCommission,commissionRate:affiliate.commissionRate,status:\"pending\",type:\"monthly_recurring\"})}await db.update(referrals).set({status:\"subscribed\",subscriptionId,subscribedAt:new Date}).where(eq(referrals.id,referral.id));const totalNewCommission=[setupRecord,monthlyRecord].filter(Boolean).reduce((sum,r)=>sum+parseFloat(r.amount)*rate,0);await db.execute(drizzleSql`\n      UPDATE affiliates\n      SET totalEarnings = totalEarnings + ${totalNewCommission.toFixed(2)},\n          pendingEarnings = pendingEarnings + ${totalNewCommission.toFixed(2)}\n      WHERE id = ${affiliate.id}\n    `)}catch(error){console.error(\"[Database] Failed to create affiliate commission:\",error)}}__name(createAffiliateCommission,\"createAffiliateCommission\");async function migrateOrphanedRecords(userEmail,realUserId){const db=await getDb();if(!db)return;try{const lead=await getLeadByEmail(userEmail);if(!lead||!lead.userId||lead.userId===realUserId)return;const tempUserId=lead.userId;await db.update(subscriptions).set({userId:realUserId}).where(eq(subscriptions.userId,tempUserId));await db.update(billingRecords).set({userId:realUserId}).where(eq(billingRecords.userId,tempUserId));await db.update(aiInstances).set({userId:realUserId}).where(eq(aiInstances.userId,tempUserId));await db.update(leads).set({userId:realUserId,status:\"paid\"}).where(eq(leads.email,userEmail))}catch(error){console.error(\"[Database] Failed to migrate orphaned records:\",error)}}__name(migrateOrphanedRecords,\"migrateOrphanedRecords\");export{captureLead,createAIInstance,createAffiliateCommission,createBillingRecord,createSubscription,createSubscriptionRaw,getAIInstanceByUserId,getBillingRecordsByUserId,getDb,getLeadByEmail,getSubscriptionByUserId,getUserByOpenId,migrateOrphanedRecords,updateAIInstance,updateLeadStatus,updateSubscription,upsertUser};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/home/ubuntu/openclaw-concierge/server/db.ts"],"sourcesContent":[null]}}