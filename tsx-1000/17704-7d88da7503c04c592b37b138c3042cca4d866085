{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{AXIOS_TIMEOUT_MS,COOKIE_NAME,ONE_YEAR_MS}from\"@shared/const\";import{ForbiddenError}from\"@shared/_core/errors\";import axios from\"axios\";import{parse as parseCookieHeader}from\"cookie\";import{SignJWT,jwtVerify}from\"jose\";import*as db from\"../db\";import{ENV}from\"./env\";const isNonEmptyString=__name(value=>typeof value===\"string\"&&value.length>0,\"isNonEmptyString\");const EXCHANGE_TOKEN_PATH=`/webdev.v1.WebDevAuthPublicService/ExchangeToken`;const GET_USER_INFO_PATH=`/webdev.v1.WebDevAuthPublicService/GetUserInfo`;const GET_USER_INFO_WITH_JWT_PATH=`/webdev.v1.WebDevAuthPublicService/GetUserInfoWithJwt`;class OAuthService{constructor(client){this.client=client;console.log(\"[OAuth] Initialized with baseURL:\",ENV.oAuthServerUrl);if(!ENV.oAuthServerUrl){console.error(\"[OAuth] ERROR: OAUTH_SERVER_URL is not configured! Set OAUTH_SERVER_URL environment variable.\")}}static{__name(this,\"OAuthService\")}decodeState(state){const redirectUri=atob(state);return redirectUri}async getTokenByCode(code,state){const payload={clientId:ENV.appId,grantType:\"authorization_code\",code,redirectUri:this.decodeState(state)};const{data}=await this.client.post(EXCHANGE_TOKEN_PATH,payload);return data}async getUserInfoByToken(token){const{data}=await this.client.post(GET_USER_INFO_PATH,{accessToken:token.accessToken});return data}}const createOAuthHttpClient=__name(()=>axios.create({baseURL:ENV.oAuthServerUrl,timeout:AXIOS_TIMEOUT_MS}),\"createOAuthHttpClient\");class SDKServer{static{__name(this,\"SDKServer\")}client;oauthService;constructor(client=createOAuthHttpClient()){this.client=client;this.oauthService=new OAuthService(this.client)}deriveLoginMethod(platforms,fallback){if(fallback&&fallback.length>0)return fallback;if(!Array.isArray(platforms)||platforms.length===0)return null;const set=new Set(platforms.filter(p=>typeof p===\"string\"));if(set.has(\"REGISTERED_PLATFORM_EMAIL\"))return\"email\";if(set.has(\"REGISTERED_PLATFORM_GOOGLE\"))return\"google\";if(set.has(\"REGISTERED_PLATFORM_APPLE\"))return\"apple\";if(set.has(\"REGISTERED_PLATFORM_MICROSOFT\")||set.has(\"REGISTERED_PLATFORM_AZURE\"))return\"microsoft\";if(set.has(\"REGISTERED_PLATFORM_GITHUB\"))return\"github\";const first=Array.from(set)[0];return first?first.toLowerCase():null}async exchangeCodeForToken(code,state){return this.oauthService.getTokenByCode(code,state)}async getUserInfo(accessToken){const data=await this.oauthService.getUserInfoByToken({accessToken});const loginMethod=this.deriveLoginMethod(data?.platforms,data?.platform??data.platform??null);return{...data,platform:loginMethod,loginMethod}}parseCookies(cookieHeader){if(!cookieHeader){return new Map}const parsed=parseCookieHeader(cookieHeader);return new Map(Object.entries(parsed))}getSessionSecret(){const secret=ENV.cookieSecret;return new TextEncoder().encode(secret)}async createSessionToken(openId,options={}){return this.signSession({openId,appId:ENV.appId,name:options.name||\"\"},options)}async signSession(payload,options={}){const issuedAt=Date.now();const expiresInMs=options.expiresInMs??ONE_YEAR_MS;const expirationSeconds=Math.floor((issuedAt+expiresInMs)/1e3);const secretKey=this.getSessionSecret();return new SignJWT({openId:payload.openId,appId:payload.appId,name:payload.name}).setProtectedHeader({alg:\"HS256\",typ:\"JWT\"}).setExpirationTime(expirationSeconds).sign(secretKey)}async verifySession(cookieValue){if(!cookieValue){console.warn(\"[Auth] Missing session cookie\");return null}try{const secretKey=this.getSessionSecret();const{payload}=await jwtVerify(cookieValue,secretKey,{algorithms:[\"HS256\"]});const{openId,appId,name}=payload;if(!isNonEmptyString(openId)||!isNonEmptyString(appId)||typeof name!==\"string\"){console.warn(\"[Auth] Session payload missing required fields\");return null}return{openId,appId,name}}catch(error){console.warn(\"[Auth] Session verification failed\",String(error));return null}}async getUserInfoWithJwt(jwtToken){const payload={jwtToken,projectId:ENV.appId};const{data}=await this.client.post(GET_USER_INFO_WITH_JWT_PATH,payload);const loginMethod=this.deriveLoginMethod(data?.platforms,data?.platform??data.platform??null);return{...data,platform:loginMethod,loginMethod}}async authenticateRequest(req){const cookies=this.parseCookies(req.headers.cookie);const sessionCookie=cookies.get(COOKIE_NAME);const session=await this.verifySession(sessionCookie);if(!session){throw ForbiddenError(\"Invalid session cookie\")}const sessionUserId=session.openId;const signedInAt=new Date;let user=await db.getUserByOpenId(sessionUserId);if(!user){try{const userInfo=await this.getUserInfoWithJwt(sessionCookie??\"\");await db.upsertUser({openId:userInfo.openId,name:userInfo.name||void 0,email:userInfo.email||void 0,loginMethod:userInfo.loginMethod||userInfo.platform||void 0,lastSignedIn:signedInAt});user=await db.getUserByOpenId(userInfo.openId)}catch(error){console.error(\"[Auth] Failed to sync user from OAuth:\",error);throw ForbiddenError(\"Failed to sync user info\")}}if(!user){throw ForbiddenError(\"User not found\")}await db.upsertUser({openId:user.openId,lastSignedIn:signedInAt});return user}}const sdk=new SDKServer;export{sdk};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/home/ubuntu/openclaw-concierge/server/_core/sdk.ts"],"sourcesContent":[null]}}