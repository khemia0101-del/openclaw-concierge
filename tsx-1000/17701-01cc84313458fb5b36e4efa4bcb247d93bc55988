{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{COOKIE_NAME,ONE_YEAR_MS}from\"@shared/const\";import*as db from\"../db\";import{getSessionCookieOptions}from\"./cookies\";import{sdk}from\"./sdk\";function getQueryParam(req,key){const value=req.query[key];return typeof value===\"string\"?value:void 0}__name(getQueryParam,\"getQueryParam\");function registerOAuthRoutes(app){app.get(\"/api/oauth/callback\",async(req,res)=>{const code=getQueryParam(req,\"code\");const state=getQueryParam(req,\"state\");if(!code||!state){res.status(400).json({error:\"code and state are required\"});return}try{const tokenResponse=await sdk.exchangeCodeForToken(code,state);const userInfo=await sdk.getUserInfo(tokenResponse.accessToken);if(!userInfo.openId){res.status(400).json({error:\"openId missing from user info\"});return}await db.upsertUser({openId:userInfo.openId,name:userInfo.name||void 0,email:userInfo.email||void 0,loginMethod:userInfo.loginMethod||userInfo.platform||void 0,lastSignedIn:new Date});const sessionToken=await sdk.createSessionToken(userInfo.openId,{name:userInfo.name||\"\",expiresInMs:ONE_YEAR_MS});const cookieOptions=getSessionCookieOptions(req);res.cookie(COOKIE_NAME,sessionToken,{...cookieOptions,maxAge:ONE_YEAR_MS});res.redirect(302,\"/\")}catch(error){console.error(\"[OAuth] Callback failed\",error);res.status(500).json({error:\"OAuth callback failed\"})}})}__name(registerOAuthRoutes,\"registerOAuthRoutes\");export{registerOAuthRoutes};\n","warnings":[],"map":{"version":3,"mappings":"kHAAA,OAAS,YAAa,gBAAmB,gBAEzC,UAAY,OAAQ,QACpB,OAAS,4BAA+B,YACxC,OAAS,QAAW,QAEpB,SAAS,cAAc,IAAc,IAAiC,CACpE,MAAM,MAAQ,IAAI,MAAM,GAAG,EAC3B,OAAO,OAAO,QAAU,SAAW,MAAQ,MAC7C,CAHS,sCAKF,SAAS,oBAAoB,IAAc,CAChD,IAAI,IAAI,sBAAuB,MAAO,IAAc,MAAkB,CACpE,MAAM,KAAO,cAAc,IAAK,MAAM,EACtC,MAAM,MAAQ,cAAc,IAAK,OAAO,EAExC,GAAI,CAAC,MAAQ,CAAC,MAAO,CACnB,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,6BAA8B,CAAC,EAC7D,MACF,CAEA,GAAI,CACF,MAAM,cAAgB,MAAM,IAAI,qBAAqB,KAAM,KAAK,EAChE,MAAM,SAAW,MAAM,IAAI,YAAY,cAAc,WAAW,EAEhE,GAAI,CAAC,SAAS,OAAQ,CACpB,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,+BAAgC,CAAC,EAC/D,MACF,CAEA,MAAM,GAAG,WAAW,CAClB,OAAQ,SAAS,OACjB,KAAM,SAAS,MAAQ,OACvB,MAAO,SAAS,OAAS,OACzB,YAAa,SAAS,aAAe,SAAS,UAAY,OAC1D,aAAc,IAAI,IACpB,CAAC,EAED,MAAM,aAAe,MAAM,IAAI,mBAAmB,SAAS,OAAQ,CACjE,KAAM,SAAS,MAAQ,GACvB,YAAa,WACf,CAAC,EAED,MAAM,cAAgB,wBAAwB,GAAG,EACjD,IAAI,OAAO,YAAa,aAAc,CAAE,GAAG,cAAe,OAAQ,WAAY,CAAC,EAE/E,IAAI,SAAS,IAAK,GAAG,CACvB,OAAS,MAAO,CACd,QAAQ,MAAM,0BAA2B,KAAK,EAC9C,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,uBAAwB,CAAC,CACzD,CACF,CAAC,CACH,CAzCgB","names":[],"ignoreList":[],"sources":["/home/ubuntu/openclaw-concierge/server/_core/oauth.ts"],"sourcesContent":[null]}}