{"code":"import{COOKIE_NAME}from\"@shared/const\";import{getSessionCookieOptions}from\"./_core/cookies\";import{systemRouter}from\"./_core/systemRouter\";import{publicProcedure,router,protectedProcedure}from\"./_core/trpc\";import{z}from\"zod\";import*as db from\"./db\";import*as stripeService from\"./services/stripe\";import*as digitaloceanService from\"./services/digitalocean\";const appRouter=router({system:systemRouter,auth:router({me:publicProcedure.query(opts=>opts.ctx.user),logout:publicProcedure.mutation(({ctx})=>{const cookieOptions=getSessionCookieOptions(ctx.req);ctx.res.clearCookie(COOKIE_NAME,{...cookieOptions,maxAge:-1});return{success:true}})}),onboarding:router({createCheckout:publicProcedure.input(z.object({email:z.string().email(),tier:z.enum([\"starter\",\"pro\",\"business\"]),userId:z.number()})).mutation(async({input})=>{const session=await stripeService.createCheckoutSession({customerEmail:input.email,tier:input.tier,userId:input.userId,successUrl:`${process.env.VITE_APP_URL||\"http://localhost:3000\"}/onboarding/configure?session_id={CHECKOUT_SESSION_ID}`,cancelUrl:`${process.env.VITE_APP_URL||\"http://localhost:3000\"}/onboarding/payment`});return{sessionUrl:session.url,sessionId:session.id}}),verifyPayment:publicProcedure.input(z.object({sessionId:z.string(),userId:z.number(),tier:z.enum([\"starter\",\"pro\",\"business\"])})).mutation(async({input})=>{const session=await stripeService.getCheckoutSession(input.sessionId);if(session.payment_status!==\"paid\"){throw new Error(\"Payment not completed\")}await db.createSubscription({userId:input.userId,tier:input.tier,status:\"active\",setupFeePaid:true,stripeCustomerId:session.customer,monthlyPrice:stripeService.PRICING[input.tier].monthlyPrice.toString(),startDate:new Date,renewalDate:new Date(Date.now()+30*24*60*60*1e3)});const setupFee=stripeService.PRICING[input.tier].setupFee;const monthlyFee=stripeService.PRICING[input.tier].monthlyPrice;await db.createBillingRecord({userId:input.userId,type:\"setup_fee\",amount:(setupFee/100).toFixed(2),status:\"completed\",stripeChargeId:session.payment_intent});await db.createBillingRecord({userId:input.userId,type:\"monthly_subscription\",amount:(monthlyFee/100).toFixed(2),status:\"completed\"});return{success:true}}),deployInstance:protectedProcedure.input(z.object({aiRole:z.string(),telegramBotToken:z.string().optional(),communicationChannels:z.array(z.string()),connectedServices:z.array(z.string())})).mutation(async({ctx,input})=>{const userId=ctx.user.id;const subscription=await db.getSubscriptionByUserId(userId);if(!subscription){throw new Error(\"No active subscription found\")}const instanceResult=await db.createAIInstance({userId,subscriptionId:subscription.id,status:\"provisioning\",aiRole:input.aiRole,telegramBotToken:input.telegramBotToken,config:{communicationChannels:input.communicationChannels,connectedServices:input.connectedServices}});try{const app=await digitaloceanService.createOpenClawApp({userId,userEmail:ctx.user.email||\"\",aiRole:input.aiRole,tier:subscription.tier,telegramBotToken:input.telegramBotToken,config:{communicationChannels:input.communicationChannels,connectedServices:input.connectedServices}});await db.updateAIInstance(instanceResult[0].insertId,{doAppId:app.id,status:\"running\"});return{success:true,appId:app.id}}catch(error){await db.updateAIInstance(instanceResult[0].insertId,{status:\"error\",errorMessage:error.message});throw error}})}),dashboard:router({getStatus:protectedProcedure.query(async({ctx})=>{const subscription=await db.getSubscriptionByUserId(ctx.user.id);const instance=await db.getAIInstanceByUserId(ctx.user.id);const billingRecords=await db.getBillingRecordsByUserId(ctx.user.id);return{subscription,instance,billingRecords}}),restartInstance:protectedProcedure.mutation(async({ctx})=>{const instance=await db.getAIInstanceByUserId(ctx.user.id);if(!instance||!instance.doAppId){throw new Error(\"No instance found\")}await digitaloceanService.restartApp(instance.doAppId);return{success:true}}),getLogs:protectedProcedure.query(async({ctx})=>{const instance=await db.getAIInstanceByUserId(ctx.user.id);if(!instance||!instance.doAppId){return{logs:[]}}const logs=await digitaloceanService.getAppLogs(instance.doAppId);return{logs}})})});export{appRouter};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/home/ubuntu/openclaw-concierge/server/routers.ts"],"sourcesContent":[null]}}