{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{constructWebhookEvent}from\"../services/stripe\";const WEBHOOK_SECRET=process.env.STRIPE_WEBHOOK_SECRET||\"\";async function handleStripeWebhook(req,res){const signature=req.headers[\"stripe-signature\"];if(!signature){console.error(\"[Stripe Webhook] Missing signature\");return res.status(400).json({error:\"Missing signature\"})}let event;try{event=constructWebhookEvent(req.body,signature,WEBHOOK_SECRET)}catch(err){console.error(\"[Stripe Webhook] Signature verification failed:\",err.message);return res.status(400).json({error:\"Invalid signature\"})}if(event.id.startsWith(\"evt_test_\")){console.log(\"[Stripe Webhook] Test event detected, returning verification response\");return res.json({verified:true})}console.log(`[Stripe Webhook] Received event: ${event.type}`);try{switch(event.type){case\"checkout.session.completed\":{const session=event.data.object;const userId=parseInt(session.metadata?.userId||session.client_reference_id||\"0\");const tier=session.metadata?.tier;if(!userId||!tier){console.error(\"[Stripe Webhook] Missing userId or tier in metadata\");break}console.log(`[Stripe Webhook] Payment completed for user ${userId}, tier ${tier}`);break}case\"payment_intent.succeeded\":{const paymentIntent=event.data.object;console.log(`[Stripe Webhook] Payment intent succeeded: ${paymentIntent.id}`);break}case\"payment_intent.payment_failed\":{const paymentIntent=event.data.object;console.error(`[Stripe Webhook] Payment failed: ${paymentIntent.id}`);break}case\"customer.created\":{const customer=event.data.object;console.log(`[Stripe Webhook] Customer created: ${customer.id}`);break}default:console.log(`[Stripe Webhook] Unhandled event type: ${event.type}`)}res.json({received:true})}catch(error){console.error(\"[Stripe Webhook] Error processing event:\",error);res.status(500).json({error:\"Webhook processing failed\"})}}__name(handleStripeWebhook,\"handleStripeWebhook\");export{handleStripeWebhook};\n","warnings":[],"map":{"version":3,"mappings":"kHACA,OAAS,0BAA6B,qBAGtC,MAAM,eAAiB,QAAQ,IAAI,uBAAyB,GAE5D,eAAsB,oBAAoB,IAAc,IAAe,CACrE,MAAM,UAAY,IAAI,QAAQ,kBAAkB,EAEhD,GAAI,CAAC,UAAW,CACd,QAAQ,MAAM,oCAAoC,EAClD,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,mBAAoB,CAAC,CAC5D,CAEA,IAAI,MACJ,GAAI,CACF,MAAQ,sBAAsB,IAAI,KAAM,UAAW,cAAc,CACnE,OAAS,IAAU,CACjB,QAAQ,MAAM,kDAAmD,IAAI,OAAO,EAC5E,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,mBAAoB,CAAC,CAC5D,CAGA,GAAI,MAAM,GAAG,WAAW,WAAW,EAAG,CACpC,QAAQ,IAAI,uEAAuE,EACnF,OAAO,IAAI,KAAK,CAAE,SAAU,IAAK,CAAC,CACpC,CAEA,QAAQ,IAAI,oCAAoC,MAAM,IAAI,EAAE,EAE5D,GAAI,CACF,OAAQ,MAAM,KAAM,CAClB,IAAK,6BAA8B,CACjC,MAAM,QAAU,MAAM,KAAK,OAC3B,MAAM,OAAS,SAAS,QAAQ,UAAU,QAAU,QAAQ,qBAAuB,GAAG,EACtF,MAAM,KAAO,QAAQ,UAAU,KAE/B,GAAI,CAAC,QAAU,CAAC,KAAM,CACpB,QAAQ,MAAM,qDAAqD,EACnE,KACF,CAEA,QAAQ,IAAI,+CAA+C,MAAM,UAAU,IAAI,EAAE,EAIjF,KACF,CAEA,IAAK,2BAA4B,CAC/B,MAAM,cAAgB,MAAM,KAAK,OACjC,QAAQ,IAAI,8CAA8C,cAAc,EAAE,EAAE,EAC5E,KACF,CAEA,IAAK,gCAAiC,CACpC,MAAM,cAAgB,MAAM,KAAK,OACjC,QAAQ,MAAM,oCAAoC,cAAc,EAAE,EAAE,EACpE,KACF,CAEA,IAAK,mBAAoB,CACvB,MAAM,SAAW,MAAM,KAAK,OAC5B,QAAQ,IAAI,sCAAsC,SAAS,EAAE,EAAE,EAC/D,KACF,CAEA,QACE,QAAQ,IAAI,0CAA0C,MAAM,IAAI,EAAE,CACtE,CAEA,IAAI,KAAK,CAAE,SAAU,IAAK,CAAC,CAC7B,OAAS,MAAY,CACnB,QAAQ,MAAM,2CAA4C,KAAK,EAC/D,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,2BAA4B,CAAC,CAC7D,CACF,CAtEsB","names":[],"ignoreList":[],"sources":["/home/ubuntu/openclaw-concierge/server/webhooks/stripe.ts"],"sourcesContent":[null]}}