{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{constructWebhookEvent,PRICING,getRenewalDate}from\"../services/stripe\";import*as db from\"../db\";const WEBHOOK_SECRET=process.env.STRIPE_WEBHOOK_SECRET||\"\";async function handleStripeWebhook(req,res){const signature=req.headers[\"stripe-signature\"];if(!signature){console.error(\"[Stripe Webhook] Missing signature\");return res.status(400).json({error:\"Missing signature\"})}let event;try{event=constructWebhookEvent(req.body,signature,WEBHOOK_SECRET)}catch(err){console.error(\"[Stripe Webhook] Signature verification failed:\",err.message);return res.status(400).json({error:\"Invalid signature\"})}if(event.id.startsWith(\"evt_test_\")){return res.json({verified:true})}try{switch(event.type){case\"checkout.session.completed\":{const session=event.data.object;const userId=parseInt(session.metadata?.userId||session.client_reference_id||\"0\");const tier=session.metadata?.tier;if(!userId||!tier||userId>2147483647){console.error(\"[Stripe Webhook] Missing or invalid userId/tier in metadata\");break}const existing=await db.getSubscriptionByUserId(userId);if(!existing){const monthlyPriceValue=(PRICING[tier].monthlyPrice/100).toFixed(2);let stripeCustomerId=null;if(typeof session.customer===\"string\")stripeCustomerId=session.customer;else if(session.customer?.id)stripeCustomerId=session.customer.id;let stripeSubscriptionId=null;if(typeof session.subscription===\"string\")stripeSubscriptionId=session.subscription;else if(session.subscription?.id)stripeSubscriptionId=session.subscription.id;const renewalDate=await getRenewalDate(stripeSubscriptionId);await db.createSubscriptionRaw({userId,tier,status:\"active\",setupFeePaid:true,stripeCustomerId,stripeSubscriptionId,monthlyPrice:monthlyPriceValue,startDate:new Date,renewalDate});const setupBillingResult=await db.createBillingRecord({userId,type:\"setup_fee\",amount:(PRICING[tier].setupFee/100).toFixed(2),status:\"completed\",stripeChargeId:session.payment_intent});const monthlyBillingResult=await db.createBillingRecord({userId,type:\"monthly_subscription\",amount:monthlyPriceValue,status:\"completed\"});const email=session.metadata?.customerEmail||session.customer_email||\"\";if(email){await db.updateLeadStatus(email,\"paid\",session.id,userId)}const newSub=await db.getSubscriptionByUserId(userId);if(newSub){await db.createAffiliateCommission(userId,newSub.id,setupBillingResult,monthlyBillingResult)}}break}case\"payment_intent.payment_failed\":{const paymentIntent=event.data.object;console.error(`[Stripe Webhook] Payment failed: ${paymentIntent.id}`);break}default:break}res.json({received:true})}catch(error){console.error(\"[Stripe Webhook] Error processing event:\",error);res.status(500).json({error:\"Webhook processing failed\"})}}__name(handleStripeWebhook,\"handleStripeWebhook\");export{handleStripeWebhook};\n","warnings":[],"map":{"version":3,"mappings":"kHACA,OAAS,sBAAuB,QAAS,mBAAsB,qBAC/D,UAAY,OAAQ,QAEpB,MAAM,eAAiB,QAAQ,IAAI,uBAAyB,GAE5D,eAAsB,oBAAoB,IAAc,IAAe,CACrE,MAAM,UAAY,IAAI,QAAQ,kBAAkB,EAEhD,GAAI,CAAC,UAAW,CACd,QAAQ,MAAM,oCAAoC,EAClD,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,mBAAoB,CAAC,CAC5D,CAEA,IAAI,MACJ,GAAI,CACF,MAAQ,sBAAsB,IAAI,KAAM,UAAW,cAAc,CACnE,OAAS,IAAU,CACjB,QAAQ,MAAM,kDAAmD,IAAI,OAAO,EAC5E,OAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,mBAAoB,CAAC,CAC5D,CAGA,GAAI,MAAM,GAAG,WAAW,WAAW,EAAG,CACpC,OAAO,IAAI,KAAK,CAAE,SAAU,IAAK,CAAC,CACpC,CAEA,GAAI,CACF,OAAQ,MAAM,KAAM,CAClB,IAAK,6BAA8B,CACjC,MAAM,QAAU,MAAM,KAAK,OAC3B,MAAM,OAAS,SAAS,QAAQ,UAAU,QAAU,QAAQ,qBAAuB,GAAG,EACtF,MAAM,KAAO,QAAQ,UAAU,KAE/B,GAAI,CAAC,QAAU,CAAC,MAAQ,OAAS,WAAY,CAC3C,QAAQ,MAAM,6DAA6D,EAC3E,KACF,CAGA,MAAM,SAAW,MAAM,GAAG,wBAAwB,MAAM,EACxD,GAAI,CAAC,SAAU,CACb,MAAM,mBAAqB,QAAQ,IAAI,EAAE,aAAe,KAAK,QAAQ,CAAC,EAEtE,IAAI,iBAAkC,KACtC,GAAI,OAAO,QAAQ,WAAa,SAAU,iBAAmB,QAAQ,iBAC5D,QAAQ,UAAU,GAAI,iBAAmB,QAAQ,SAAS,GAEnE,IAAI,qBAAsC,KAC1C,GAAI,OAAO,QAAQ,eAAiB,SAAU,qBAAuB,QAAQ,qBACpE,QAAQ,cAAc,GAAI,qBAAuB,QAAQ,aAAa,GAE/E,MAAM,YAAc,MAAM,eAAe,oBAAoB,EAE7D,MAAM,GAAG,sBAAsB,CAC7B,OACA,KACA,OAAQ,SACR,aAAc,KACd,iBACA,qBACA,aAAc,kBACd,UAAW,IAAI,KACf,WACF,CAAC,EAED,MAAM,mBAAqB,MAAM,GAAG,oBAAoB,CACtD,OACA,KAAM,YACN,QAAS,QAAQ,IAAI,EAAE,SAAW,KAAK,QAAQ,CAAC,EAChD,OAAQ,YACR,eAAgB,QAAQ,cAC1B,CAAC,EAED,MAAM,qBAAuB,MAAM,GAAG,oBAAoB,CACxD,OACA,KAAM,uBACN,OAAQ,kBACR,OAAQ,WACV,CAAC,EAGD,MAAM,MAAQ,QAAQ,UAAU,eAAiB,QAAQ,gBAAkB,GAC3E,GAAI,MAAO,CACT,MAAM,GAAG,iBAAiB,MAAO,OAAQ,QAAQ,GAAI,MAAM,CAC7D,CAGA,MAAM,OAAS,MAAM,GAAG,wBAAwB,MAAM,EACtD,GAAI,OAAQ,CACV,MAAM,GAAG,0BAA0B,OAAQ,OAAO,GAAI,mBAAoB,oBAAoB,CAChG,CACF,CACA,KACF,CAEA,IAAK,gCAAiC,CACpC,MAAM,cAAgB,MAAM,KAAK,OACjC,QAAQ,MAAM,oCAAoC,cAAc,EAAE,EAAE,EACpE,KACF,CAEA,QACE,KACJ,CAEA,IAAI,KAAK,CAAE,SAAU,IAAK,CAAC,CAC7B,OAAS,MAAY,CACnB,QAAQ,MAAM,2CAA4C,KAAK,EAC/D,IAAI,OAAO,GAAG,EAAE,KAAK,CAAE,MAAO,2BAA4B,CAAC,CAC7D,CACF,CAzGsB","names":[],"ignoreList":[],"sources":["/home/ubuntu/openclaw-concierge/server/webhooks/stripe.ts"],"sourcesContent":[null]}}