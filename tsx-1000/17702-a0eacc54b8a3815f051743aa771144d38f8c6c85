{"code":"import{COOKIE_NAME}from\"@shared/const\";import{getSessionCookieOptions}from\"./_core/cookies\";import{systemRouter}from\"./_core/systemRouter\";import{publicProcedure,router,protectedProcedure}from\"./_core/trpc\";import{z}from\"zod\";import*as db from\"./db\";import*as stripeService from\"./services/stripe\";import*as digitaloceanService from\"./services/digitalocean\";import{affiliateRouter}from\"./api/trpc/routers/affiliate\";const appRouter=router({system:systemRouter,auth:router({me:publicProcedure.query(opts=>opts.ctx.user),logout:publicProcedure.mutation(({ctx})=>{const cookieOptions=getSessionCookieOptions(ctx.req);ctx.res.clearCookie(COOKIE_NAME,{...cookieOptions,maxAge:-1});return{success:true}})}),onboarding:router({createCheckout:publicProcedure.input(z.object({email:z.string().email(),tier:z.enum([\"starter\",\"pro\",\"business\"]),userId:z.number(),origin:z.string().url()})).mutation(async({input})=>{await db.captureLead({email:input.email,selectedTier:input.tier,status:\"checkout_started\",source:\"onboarding\"});const session=await stripeService.createCheckoutSession({customerEmail:input.email,tier:input.tier,userId:input.userId,successUrl:`${input.origin}/onboarding/configure?session_id={CHECKOUT_SESSION_ID}`,cancelUrl:`${input.origin}/onboarding/payment`});await db.updateLeadStatus(input.email,\"checkout_started\",session.id);return{sessionUrl:session.url||\"\",sessionId:session.id}}),verifyPayment:publicProcedure.input(z.object({sessionId:z.string(),userId:z.number()})).mutation(async({input})=>{const session=await stripeService.getCheckoutSession(input.sessionId);if(session.payment_status!==\"paid\"){throw new Error(\"Payment not completed\")}const tier=session.metadata?.tier;if(!tier){throw new Error(\"Tier information missing from payment session\")}const monthlyPriceValue=stripeService.PRICING[tier].monthlyPrice/100;await db.createSubscription({userId:input.userId,tier,status:\"active\",setupFeePaid:true,stripeCustomerId:typeof session.customer===\"string\"?session.customer:session.customer?.id||null,stripeSubscriptionId:session.subscription?typeof session.subscription===\"string\"?session.subscription:session.subscription.id:null,monthlyPrice:monthlyPriceValue.toString(),startDate:new Date,renewalDate:new Date(Date.now()+30*24*60*60*1e3)});const setupFee=stripeService.PRICING[tier].setupFee;const monthlyFee=stripeService.PRICING[tier].monthlyPrice;await db.createBillingRecord({userId:input.userId,type:\"setup_fee\",amount:(setupFee/100).toFixed(2),status:\"completed\",stripeChargeId:session.payment_intent});await db.createBillingRecord({userId:input.userId,type:\"monthly_subscription\",amount:(monthlyFee/100).toFixed(2),status:\"completed\"});const email=session.metadata?.customerEmail||session.customer_email||\"\";return{success:true,email,tier}}),deployInstance:publicProcedure.input(z.object({userId:z.number(),userEmail:z.string().email(),aiRole:z.string(),telegramBotToken:z.string().optional(),communicationChannels:z.array(z.string()),connectedServices:z.array(z.string())})).mutation(async({input})=>{const userId=input.userId;const subscription=await db.getSubscriptionByUserId(userId);if(!subscription){throw new Error(\"No active subscription found\")}const instanceResult=await db.createAIInstance({userId,subscriptionId:subscription.id,status:\"provisioning\",aiRole:input.aiRole,telegramBotToken:input.telegramBotToken,config:{communicationChannels:input.communicationChannels,connectedServices:input.connectedServices}});try{const app=await digitaloceanService.createOpenClawApp({userId,userEmail:input.userEmail,aiRole:input.aiRole,tier:subscription.tier,telegramBotToken:input.telegramBotToken,config:{communicationChannels:input.communicationChannels,connectedServices:input.connectedServices}});await db.updateAIInstance(instanceResult[0].insertId,{doAppId:app.id,status:\"running\"});return{success:true,appId:app.id}}catch(error){await db.updateAIInstance(instanceResult[0].insertId,{status:\"error\",errorMessage:error.message});throw error}})}),affiliate:affiliateRouter,dashboard:router({getStatus:protectedProcedure.query(async({ctx})=>{const subscription=await db.getSubscriptionByUserId(ctx.user.id);const instance=await db.getAIInstanceByUserId(ctx.user.id);const billingRecords=await db.getBillingRecordsByUserId(ctx.user.id);return{subscription,instance,billingRecords}}),restartInstance:protectedProcedure.mutation(async({ctx})=>{const instance=await db.getAIInstanceByUserId(ctx.user.id);if(!instance||!instance.doAppId){throw new Error(\"No instance found\")}await digitaloceanService.restartApp(instance.doAppId);return{success:true}}),getLogs:protectedProcedure.query(async({ctx})=>{const instance=await db.getAIInstanceByUserId(ctx.user.id);if(!instance||!instance.doAppId){return{logs:[]}}const logs=await digitaloceanService.getAppLogs(instance.doAppId);return{logs}})})});export{appRouter};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/home/ubuntu/openclaw-concierge/server/routers.ts"],"sourcesContent":[null]}}